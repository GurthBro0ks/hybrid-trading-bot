name: discord-notify

on:
  push:
    branches: [main]
    paths-ignore:
      - "docs/**"
      - "**/*.md"
  workflow_dispatch:
    inputs:
      reason:
        description: "Why are we notifying?"
        required: false
        default: "manual dispatch"

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Post Discord alert (hardened, no-links, codeblock)
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_HYBRID_TRADING_BOT_REPO }}
          REASON: ${{ inputs.reason }}
        run: |
          set -euo pipefail

          if [ -z "${DISCORD_WEBHOOK_URL:-}" ]; then
            echo "DISCORD_WEBHOOK_HYBRID_TRADING_BOT_REPO not set; safe-skip."
            exit 0
          fi

          # Validate https + Discord host
          if ! printf '%s' "$DISCORD_WEBHOOK_URL" | grep -qE '^https://'; then
            echo "Refusing non-https webhook URL"
            exit 1
          fi
          if ! printf '%s' "$DISCORD_WEBHOOK_URL" | grep -qE '^https://(discord\.com|discordapp\.com)/api/webhooks/'; then
            echo "Refusing webhook URL with unexpected host"
            exit 1
          fi

          REPO_FULL="$GITHUB_REPOSITORY"
          REPO="${REPO_FULL#*/}"
          BRANCH="${GITHUB_REF_NAME}"
          SHA_SHORT="$(printf '%s' "$GITHUB_SHA" | cut -c1-7)"
          ACTOR="$GITHUB_ACTOR"
          SUBJECT="$(git log -1 --pretty=%s 2>/dev/null || echo 'commit')"

          # Count commits in a push event (best effort). For workflow_dispatch, treat as 1.
          COMMIT_COUNT="$(python3 -c 'import json,os; p=os.environ.get("GITHUB_EVENT_PATH",""); ev=json.load(open(p)) if p and os.path.exists(p) else {}; count=len(ev.get("commits") or []) if os.environ.get("GITHUB_EVENT_NAME")=="push" else 1; print(count)')"

          export REPO BRANCH SHA_SHORT ACTOR SUBJECT COMMIT_COUNT REASON

          # Build Discord message: bold header + code block (no URLs)
          python3 -c 'import json,os; repo=os.environ.get("REPO","repo"); branch=os.environ.get("BRANCH",""); sha=os.environ.get("SHA_SHORT","" ); actor=os.environ.get("ACTOR",""); subject=os.environ.get("SUBJECT","commit"); count=os.environ.get("COMMIT_COUNT","1"); event=os.environ.get("GITHUB_EVENT_NAME",""); reason=os.environ.get("REASON","").strip(); header=f"[{repo}] {event} {branch}: {sha} (by {actor})"; lines=[subject, f"commits: {count}"] + ([f"reason: {reason}"] if event=="workflow_dispatch" and reason else []); content="**"+header+"**\\n```text\\n" + "\\n".join(lines) + "\\n```"; payload={"username": f"CI - {repo}", "content": content, "allowed_mentions": {"parse": []}}; print(json.dumps(payload))' > /tmp/discord_payload.json

          curl -sS -X POST \
            -H 'Content-Type: application/json' \
            --data-binary @/tmp/discord_payload.json \
            "$DISCORD_WEBHOOK_URL" >/dev/null

          echo "Discord notify: posted."
