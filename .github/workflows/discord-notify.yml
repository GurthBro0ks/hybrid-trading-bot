name: discord-notify

on:
  push:
    branches: [main]
    paths-ignore:
      - "docs/**"
      - "**/*.md"
  workflow_dispatch:
    inputs:
      reason:
        description: "Why are we notifying?"
        required: false
        default: "manual dispatch"

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Post Discord alert (hardened, readable)
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_HYBRID_TRADING_BOT_REPO }}
          REASON: ${{ inputs.reason }}
        run: |
          set -euo pipefail

          if [ -z "${DISCORD_WEBHOOK_URL:-}" ]; then
            echo "DISCORD_WEBHOOK_HYBRID_TRADING_BOT_REPO not set; safe-skip."
            exit 0
          fi

          # Validate https + Discord host
          if ! printf '%s' "$DISCORD_WEBHOOK_URL" | grep -qE '^https://'; then
            echo "Refusing non-https webhook URL"
            exit 1
          fi
          if ! printf '%s' "$DISCORD_WEBHOOK_URL" | grep -qE '^https://(discord\.com|discordapp\.com)/api/webhooks/'; then
            echo "Refusing webhook URL with unexpected host"
            exit 1
          fi

          REPO_FULL="${GITHUB_REPOSITORY}"
          REPO="${REPO_FULL#*/}"
          BRANCH="${GITHUB_REF_NAME}"
          ACTOR="${GITHUB_ACTOR}"
          SHA_SHORT="$(printf '%s' "$GITHUB_SHA" | cut -c1-7)"
          SUBJECT="$(git log -1 --pretty=%s 2>/dev/null || echo 'commit')"

          # Count commits in a push event (best-effort). For workflow_dispatch, treat as 1.
          COMMIT_COUNT="$(python3 - <<'PY'
import json, os
p=os.environ.get("GITHUB_EVENT_PATH","")
try:
  ev=json.load(open(p))
except Exception:
  ev={}
if os.environ.get("GITHUB_EVENT_NAME")=="push":
  commits=ev.get("commits") or []
  print(len(commits))
else:
  print(1)
PY
          )"

          export REPO BRANCH ACTOR SHA_SHORT SUBJECT COMMIT_COUNT REASON

          python3 - <<'PY' > /tmp/discord_payload.json
import json, os

event=os.environ.get("GITHUB_EVENT_NAME","")
repo=os.environ.get("REPO","repo")
branch=os.environ.get("BRANCH","")
actor=os.environ.get("ACTOR","")
sha=os.environ.get("SHA_SHORT","")
subject=os.environ.get("SUBJECT","")
count=os.environ.get("COMMIT_COUNT","1")
reason=(os.environ.get("REASON","") or "").strip()

# Emoji + bold header
action = "Push to" if event=="push" else "Dispatch on"
header = f"ðŸš€ **{action} {branch} by {actor}:**"

# Human-readable code block (repo name included)
lines = [
  f"repo    : {repo}",
  f"subject : {subject}",
  f"sha     : {sha}",
  f"commits : {count}",
]
if event=="workflow_dispatch" and reason:
  lines.append(f"reason  : {reason}")

content = header + "\n```text\n" + "\n".join(lines) + "\n```"

payload = {
  "username": "CI",
  "content": content,
  "allowed_mentions": {"parse": []},
}
print(json.dumps(payload))
PY

          curl -sS -X POST \
            -H 'Content-Type: application/json' \
            --data-binary @/tmp/discord_payload.json \
            "$DISCORD_WEBHOOK_URL" >/dev/null

          echo "Discord notify: posted."
