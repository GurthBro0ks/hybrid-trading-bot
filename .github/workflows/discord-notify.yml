name: discord-notify

on:
  push:
    branches: [main]
    paths-ignore:
      - "docs/**"
      - "**/*.md"
  workflow_dispatch:
    inputs:
      reason:
        description: "Why are we notifying?"
        required: false
        default: "manual dispatch"

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Post Discord alert (hardened)
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_HYBRID_TRADING_BOT_REPO }}
          REASON: ${{ inputs.reason }}
        run: |
          set -euo pipefail

          if [ -z "${DISCORD_WEBHOOK_URL:-}" ]; then
            echo "DISCORD_WEBHOOK_HYBRID_TRADING_BOT_REPO not set; safe-skip."
            exit 0
          fi

          # Validate https + Discord host
          if ! printf '%s' "$DISCORD_WEBHOOK_URL" | grep -qE '^https://'; then
            echo "Refusing non-https webhook URL"
            exit 1
          fi
          if ! printf '%s' "$DISCORD_WEBHOOK_URL" | grep -qE '^https://(discord\.com|discordapp\.com)/api/webhooks/'; then
            echo "Refusing webhook URL with unexpected host"
            exit 1
          fi

          REPO_FULL="$GITHUB_REPOSITORY"
          REPO="${REPO_FULL#*/}"
          BRANCH="${GITHUB_REF_NAME}"
          SHA_SHORT="$(printf '%s' "$GITHUB_SHA" | cut -c1-7)"
          ACTOR="$GITHUB_ACTOR"
          RUN_URL="https://github.com/${REPO_FULL}/actions/runs/${GITHUB_RUN_ID}"
          SUBJECT="$(git log -1 --pretty=%s 2>/dev/null || echo 'commit')"

          CONTENT="[$REPO] ${GITHUB_EVENT_NAME} ${BRANCH}: ${SHA_SHORT} — ${SUBJECT} (by ${ACTOR})"
          if [ "${GITHUB_EVENT_NAME}" = "workflow_dispatch" ] && [ -n "${REASON:-}" ]; then
            CONTENT="${CONTENT} — reason: ${REASON}"
          fi
          CONTENT="${CONTENT}\n${RUN_URL}"
          export CONTENT

          # Build JSON via python so newlines/quotes are escaped correctly; no mentions allowed
          python3 - <<'PY' > /tmp/discord_payload.json
import json, os
repo = os.environ.get("GITHUB_REPOSITORY","").split("/")[-1] or "repo"
content = os.environ.get("CONTENT","")
payload = {
  "username": f"CI — {repo}",
  "content": content,
  "allowed_mentions": {"parse": []},
}
print(json.dumps(payload))
PY

          curl -sS -X POST \
            -H 'Content-Type: application/json' \
            --data-binary @/tmp/discord_payload.json \
            "$DISCORD_WEBHOOK_URL" >/dev/null

          echo "Discord notify: posted."
